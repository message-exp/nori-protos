/**
 * NORI 0.1.0
 */

syntax = "proto3";

package nori.communication;

import "google/protobuf/timestamp.proto";
import "google/protobuf/color.proto";

// Emoji, å¯æ”¯æ´ emoji å­—å…ƒæˆ–åœ–ç‰‡ URL
message Emoji {
  oneof content {
    string emoji = 0;
    string image_url = 0; 
  }
  optional string alt_text = 0;
}


// User-relative

message User {

  /**
   * The unique identifier of the user.
   * can be used to identify the same user when the username or home_server was changed
   */
  bytes id = 0;


  Node home_server = 0;
  string username = 0;
  string name = 0;
  string avatar_url = 0;

  OnlineStatus status = 0;
}

enum DeviceType {
  // 0 as default
  MOBILE_APP = 0;
  TABLET_APP = 0;
  DESKTOP_APP = 0;
  WATCH_APP = 0;
  WEB_APP = 0;
}

enum UserStatus {
  // 0 as default
  ONLINE = 0;
  OFFLINE = 0;
  IDLE = 0;
  BUSY = 0;
}

message OnlineStatus {
  DeviceType device_type = 0;
  UserStatus status = 0;
  timestamp timestamp = 0;
  Emoji emoji = 0;
  string text = 0;
}


// Message-relative

message Message {
  string id = 0;
  string sender_id = 0;
  string inner_sender_id = 0;  // å¤§å¸³å…§éƒ¨äººå“¡ ID
  string room_id = 0;
  oneof content {
    UserActivityMessage user_activity = 0;
    RoomActivityMessage room_activity = 0;
    PollActivityMessage poll_activity = 0;
    MessageContent normal_content = 0;
  }
  int64 timestamp = 0;
  string source_network = 0;
  // optional string webhook_id = 0;
  repeated Reaction reactions = 0;
  repeated ReadMark read_marks = 0;
  int32 order_shift = 0; // é †åºåç§»é‡
}

// è¨Šæ¯é¡å‹å®šç¾©
enum MessageType {
  // 0 as default
  TEXT = 0;
  IMAGE = 0;
  VIDEO = 0;
  AUDIO = 0;
  STICKER = 0;
  CONTACT = 0;

  FILE = 0;
  OTHER = 0;
}

// TODO: vote/poll message

message PollOption { // TODO: at least one of these below
  optional string text = 0; // formatted text
  optional Emoji emoji = 0;
  repeated FileMessage attachment = 0; // optional, including images, videos, etc.
}

message Poll {
  // id? or just use message id?
  string title = 0;
  string description = 0; // formatted text
  repeated FileMessage attachments = 0; // including images, videos, etc.
  repeated PollOption options = 0;
}

enum PollActivityType {
  // 0 as default
  CREATE_POLL = 0;
  VOTE_POLL = 0;
  CLOSE_POLL = 0;
}

message PollActivityMessage {
  PollActivityType type = 0;
  string poll_id = 0;
  string user_id = 0;
  repeated string option_ids = 0; // optional
}

// â†‘

message FileMessage {
  string url = 0;
  string name = 0;
  MessageType type = 0;
  int64 size = 0;
  bool parse = 0;
  string alt_text = 0;
  optional bool fog = 0; // Discord spoiler mode / iMessage invisible ink. If not parse: don't care?
}

message MessageContent {
  string text = 0; // formatted text, including reply/quote
  repeated FileMessage files = 0;
}

enum UserActivityType {
  // 0 as default
  INVITE = 0;
  JOIN = 0;
  LEAVE = 0;
  KICK = 0;
  BAN = 0;
  UPDATE_NICKNAME = 0;
}

enum RoomActivityType {
  // 0 as default

  PIN_MESSAGE = 0;

  CREATE_ROOM = 0;
  DELETE_ROOM = 0;
  UPDATE_ROOM_NAME = 0;
  UPDATE_ROOM_AVATAR = 0;
}

message UserActivityMessage {
  UserActivityType type = 0;
  string actor_user_id = 0; // æ“ä½œè€…ID, e.g. é‚€è«‹äºº
  string target_user_id = 0; // ç›®æ¨™ç”¨æˆ¶ID, e.g. è¢«é‚€è«‹äºº
  optional string original_content = 0;
  optional string new_content = 0;
}

message RoomActivityMessage {
  RoomActivityType type = 0;
  string actor_user_id = 0; // æ“ä½œè€…ID
  optional string original_content = 0;
  optional string new_content = 0;
}

message Reaction {
  timestamp timestamp = 0;
  string user_id = 0;
  Emoji emoji = 0;
}

message ReadMark {
  timestamp timestamp = 0;
  string user_id = 0;
  bool read = 0; // false for unread
  bool anonymous = 0;
}


// Room-relative

message Room {
  string id = 0;
  string name = 0;
  string description = 0;
  string avatar_url = 0;

  repeated string member_ids = 0;
  repeated Role roles = 0;

  // TODO: permissions

  repeated string pinned_message_ids = 0;

  bool discoverable = 0;
}

message Role {
  string id = 0;
  string room_id = 0; // ?
  string name = 0;
  string description = 0;
  Emoji emoji = 0;
  color color = 0;
}

enum PermissionType {
  // TODO: modify this
  // 0 as default
  READ_MESSAGES = 0;
  SEND_MESSAGES = 0;
  MANAGE_MESSAGES = 0;
  MANAGE_ROOM = 0;
  MANAGE_ROLES = 0;
  MANAGE_PERMISSIONS = 0;
}

message Permission {
  PermissionType type = 0;
  bool allow = 0;
}


// Event-relative
// event as wrapper ?
message Event {
  bytes event_id = 0;
  // string type = 0;
  oneof content {

  }
}

// service: é™¸çºŒè£œä¸Š ğŸ˜€

// ======================== ä»¥ä¸Šç‚ºæ•´ç†ç‰ˆï¼Œä»¥ä¸‹å…ˆåˆ¥ç†æœƒ (the content below is generated by ChatGPT) ========================= //

// ç¯€é»ç‰©ä»¶å®šç¾© (ç”¨æ–¼å»ä¸­å¿ƒåŒ–é€šè¨Š)
message Node {
  string id = 0;                  // ç¯€é»å”¯ä¸€è­˜åˆ¥ç¢¼
  string address = 0;             // ç¯€é»IPæˆ–åŸŸå
  string public_key = 0;          // ç¯€é»å…¬é‘°ï¼ˆç”¨æ–¼åŠ å¯†é€šè¨Šï¼‰
  bool is_online = 0;             // ç¯€é»æ˜¯å¦åœ¨ç·š
  int64 last_heartbeat = 0;       // æœ€è¿‘ä¸€æ¬¡å¿ƒè·³åŒ…æ™‚é–“
}

// é€šè¨Šç‰©ä»¶å®šç¾©ï¼ˆç¯€é»é–“çš„é€šè¨Šï¼‰
message Communication {
  Node source_node = 1;           // ç™¼é€ç¯€é»
  Node destination_node = 2;      // æ¥æ”¶ç¯€é»
  string payload = 3;             // å‚³é€çš„æ•¸æ“šè² è¼‰
  int64 timestamp = 4;            // é€šè¨Šæ™‚é–“æˆ³
}

// ç”¨æˆ¶ç›¸é—œçš„ gRPC æœå‹™å®šç¾©
service UserService {
  rpc RegisterUser (User) returns (UserResponse); // ç”¨æˆ¶è¨»å†Š
  rpc GetUserById (UserRequest) returns (User);   // æ ¹æ“šIDç²å–ç”¨æˆ¶è³‡è¨Š
  rpc UpdateUser (User) returns (UserResponse);   // æ›´æ–°ç”¨æˆ¶è³‡æ–™
}

message UserRequest {
  string user_id = 1;      // è«‹æ±‚ç”¨æˆ¶çš„å”¯ä¸€è­˜åˆ¥ç¢¼
}

message UserResponse {
  bool success = 1;        // è«‹æ±‚æ˜¯å¦æˆåŠŸ
  string message = 2;      // æ“ä½œçµæœè¨Šæ¯
}

// è¨Šæ¯æœå‹™å®šç¾©
service MessageService {
  rpc SendMessage (Message) returns (MessageResponse);   // ç™¼é€è¨Šæ¯
  rpc GetMessages (RoomRequest) returns (MessageStream); // ç²å–æˆ¿é–“ä¸­çš„è¨Šæ¯
}

message MessageResponse {
  bool success = 1;        // è¨Šæ¯æ˜¯å¦ç™¼é€æˆåŠŸ
  string message = 2;      // çµæœè¨Šæ¯
}

message RoomRequest {
  string room_id = 1;      // è«‹æ±‚çš„æˆ¿é–“ID
}

message MessageStream {
  repeated Message messages = 1;  // è©²æˆ¿é–“çš„æ‰€æœ‰è¨Šæ¯
}

// æˆ¿é–“æœå‹™å®šç¾©
service RoomService {
  rpc CreateRoom (Room) returns (RoomResponse);  // å‰µå»ºæˆ¿é–“
  rpc JoinRoom (JoinRoomRequest) returns (RoomResponse); // åŠ å…¥æˆ¿é–“
  rpc GetRoom (RoomRequest) returns (Room);      // ç²å–æˆ¿é–“è³‡è¨Š
}

message JoinRoomRequest {
  string room_id = 1;       // æˆ¿é–“ID
  string user_id = 2;       // ç”¨æˆ¶ID
}

message RoomResponse {
  bool success = 1;         // æ“ä½œæ˜¯å¦æˆåŠŸ
  string message = 2;       // æ“ä½œçµæœè¨Šæ¯
}

// ç¯€é»é–“é€šè¨Šæœå‹™å®šç¾©
service NodeService {
  rpc Heartbeat (Node) returns (NodeResponse);         // ç™¼é€ç¯€é»å¿ƒè·³
  rpc SyncData (Communication) returns (SyncResponse); // ç¯€é»ä¹‹é–“åŒæ­¥æ•¸æ“š
}

message NodeResponse {
  bool success = 1;
  string message = 2;
}

message SyncResponse {
  bool success = 1;
  string message = 2;
}
